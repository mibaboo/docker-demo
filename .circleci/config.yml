# .circleci/config.yml
version: 2.1

# Declare the Orbs you want to use
orbs:
  aws-ecr: circleci/aws-ecr@9.5.4

# Define reusable parameters for the entire pipeline
parameters:
  app_name:
    type: string
    default: "python-demo" # Your application name (e.g., from your Azure DevOps variable)
  aws_region:
    type: string
    default: "eu-west-1" # Your AWS region

# Define your jobs
jobs:
  build_and_push_image:
    executor: aws-ecr/default
    working_directory: ~/project

    steps:
      - checkout

      - run:
          name: Get short Git hash
          command: |
            SHORT_HASH=$(git rev-parse --short=7 HEAD)
            echo "export SHORT_HASH=$SHORT_HASH" >> "$BASH_ENV"
            echo "Full git hash: $(git rev-parse HEAD)"
            echo "Short git hash: $SHORT_HASH"

      - aws-ecr/build-and-push-image:
          # IMPORTANT: Use 'pipeline.parameters' here because app_name and aws_region are pipeline parameters
          repo: isa/<< pipeline.parameters.app_name >>
          tag: main-$SHORT_HASH
          dockerfile: Dockerfile
          path: .
          region: << pipeline.parameters.aws_region >>

# Define your workflows
workflows:
  build_and_push_image_workflow:
    jobs:
      - build_and_push_image:
          context: aws-creds
          # No filters for now as per your previous successful run.
